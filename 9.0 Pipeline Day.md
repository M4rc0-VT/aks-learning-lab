**Pipeline Day**.

We are about to cross the final bridge: automating *everything*.
By the end of this session, you will push one line of code to GitHub, and a robot will:

1.  Build your Docker Image.
2.  Push it to your Private Vault (ACR).
3.  Deploy it to your Cluster (AKS).

-----

### **Step 1: The "Wake Up" Protocol** üèóÔ∏è

Since you destroyed everything yesterday, we need the hardware back online before we can build the software pipeline.

1.  Open your terminal to `C:\k8s-lab\terraform`.
2.  Run:
    ```powershell
    terraform apply
    ```
    *(Type `yes` when asked).*

**While that builds (6-8 minutes), let's set up the "Robot" headquarters on GitHub.**

-----

### **Step 2: Create the GitHub Repository** üêô

We need a place for your code to live in the cloud.

1.  Log in to [GitHub.com](https://github.com/).
2.  Click the **+** icon (top right) -\> **New repository**.
3.  Name it: **`aks-learning-lab`**.
4.  Visibility: **Public** (Easier for now) or **Private** (If you prefer).
5.  Click **Create repository**.

-----

### **Step 3: Connect Your Laptop** üíª

Now, link your local folder to this new cloud repo.
*(Run these commands inside your main lab folder `C:\k8s-lab` ‚Äî NOT inside the terraform folder)*

```powershell
cd C:\k8s-lab
git init
git add .
git commit -m "Day 8: Initial commit with Terraform and Helm"
git branch -M main
# Replace <YOUR_USERNAME> with your actual GitHub username
git remote add origin https://github.com/<YOUR_USERNAME>/aks-learning-lab.git
git push -u origin main
```
------------------------

## **Why GitHub and not Azure DevOps?** 

This is the "Million Dollar Question" in the Microsoft ecosystem right now. üí∞
If you ask this in a room of DevOps Engineers, you will start a very long debate.

Here is the "Senior Engineer" answer to why we (and much of the industry) are choosing GitHub over Azure DevOps (ADO), even for Azure-hosted projects.

### **1. The "Two Kings" Problem** üëë

Microsoft owns **both** platforms.

  * **Azure DevOps:** The "Classic Enterprise" tool. It is powerful, stable, and great for project management (Boards), but it feels a bit like "Legacy" software.
  * **GitHub:** The "Future" platform. Microsoft bought GitHub in 2018 for $7.5 billion. Since then, almost all their major innovation (AI Copilot, Advanced Security, Codespaces) has gone into GitHub, not Azure DevOps.

### **2. Why the Industry is Shifting to GitHub** üöÄ

Even big banks and enterprises are moving from ADO to GitHub for a few reasons:

  * **The "Center of Gravity":** 99% of the world's open-source code lives on GitHub. If you want to use the latest tools (like Helm charts or Terraform modules), they are native to GitHub. Azure DevOps often feels like an island.
  * **GitHub Actions:** The pipeline tool we will use today (Actions) is the modern standard. It is generally faster to set up and has a massive marketplace of community-built plugins compared to Azure Pipelines.
  * **Security:** GitHub's "Advanced Security" (scanning your code for secrets and vulnerabilities) is the gold standard, and Microsoft brings these features to GitHub *first*.

### **3. Why would a company stick with Azure DevOps?** üè¢

Your intuition is correct‚Äîmany companies *do* stay with ADO, usually for two reasons:

  * **Azure Boards:** The project management tool (Jira alternative) in ADO is still much better than GitHub Projects.
  * **Legacy:** Moving 5 years of pipelines from ADO to GitHub is expensive and risky.

**For us (The Learning Lab):**
We use **GitHub** because it is free, it is where the "Cloud Native" world lives, and learning **GitHub Actions** will make you more employable in 2025 than learning Azure Pipelines (Classic).

-----

### **Ready to build the Robot?** ü§ñ

Since you have your code on GitHub now, let's create the **Workflow** that will automate your job.

**Step 1: The Folder Structure**
GitHub looks for pipelines in a very specific hidden folder.

1.  In your `C:\k8s-lab` folder (VS Code), create this folder path exactly:
    `.github/workflows`
    *(Note the dot at the start of `.github`)*

2.  Inside that folder, create a file named:
    `deploy.yaml`

**Step 2: The "Brain" of the Operation** üß†
Paste this code into `deploy.yaml`. This is your CI/CD Pipeline.

```yaml
name: Build and Deploy to AKS

on:
  push:
    branches: ["main"]
  workflow_dispatch: # Allows you to click a button to run it manually

env:
  ACR_NAME: "acrlearninglab..." # <--- UPDATE THIS with your actual ACR Name
  AKS_RESOURCE_GROUP: "rg-terraform-lab"
  AKS_CLUSTER_NAME: "aks-terraform-lab"

permissions:
  id-token: write # Required for the "Robot" login (OIDC)
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Login to Azure (The Digital Handshake)
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 3. Login to ACR (The Vault)
      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      # 4. Build and Push Docker Image
      - name: Build and Push Image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/my-nginx:${{ github.sha }} .
          docker push ${{ env.ACR_NAME }}.azurecr.io/my-nginx:${{ github.sha }}

      # 5. Get AKS Credentials
      - name: Get AKS Credentials
        run: az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP --name ${{ env.AKS_CLUSTER_NAME }}

      # 6. Deploy with Helm
      - name: Deploy to AKS
        run: |
          helm upgrade --install my-release ./my-nginx-app \
            --set image.repository=${{ env.ACR_NAME }}.azurecr.io/my-nginx \
            --set image.tag=${{ github.sha }}
```

**Action:**

1.  Paste this code.
2.  Update the `ACR_NAME` at the top with your real registry name.
3.  **Do NOT push it yet.** We need to give GitHub the secrets first.

----------------

I apologize for rushing\! You are completely right‚ÄîI gave you the file earlier but we got distracted by the "Secret" setup, and I never properly explained *what* that file is or explicitly told you to push it *after* the secret was ready.

Let's pause and do this right. üõë

### **1. What is `deploy.yaml`? (The Instruction Manual)** üìú

This file is the "brain" of your robot. Without it, GitHub is just a file storage folder (like Dropbox). When you add this file, GitHub turns into an Automation Server.

Here is what the file tells the GitHub Robot to do, step-by-step:

  * **`on: push`**: "Wake up every time Marco pushes code to the `main` branch."
  * **`azure/login`**: "Use the `AZURE_CREDENTIALS` (the JSON you just pasted) to log into Marco's Azure account."
  * **`docker build & push`**: "Take the code, wrap it in a container, and ship it to the Private Vault (ACR) we built."
  * **`helm upgrade`**: "Talk to the AKS Cluster and tell it to download this specific new version."

### **2. Verify the File is Ready** üìÇ

Before we push, let's make sure the file is in the exact right spot, or GitHub won't see it.

1.  Open VS Code.
2.  Look at your file explorer on the left.
3.  Ensure you have a folder named **`.github`** (with a dot).
4.  Inside that, a folder named **`workflows`**.
5.  Inside that, your **`deploy.yaml`** file.

**Check the content one last time:**
Does the `ACR_NAME` at the top match your *actual* registry name (the one you found with the CLI earlier)? If not, update it and save.

### **3. The Trigger** üî´

Now that the Secret is safely stored in GitHub settings, it is safe to push this file. This "Push" will be the button that starts the engine.

Run these commands in your VS Code terminal:

```powershell
# 1. Stage the new workflow file
git add .github/workflows/deploy.yaml

# 2. Commit it (Stamp it)
git commit -m "Add CI/CD pipeline"

# 3. Push it (Send it to the cloud)
git push
```

### **4. Watch the Magic** üì∫

As soon as that command finishes:

1.  Go to your GitHub Repository in your browser.
2.  Click the **Actions** tab (top menu).
3.  You should see a new row appear named **"Build and Deploy to AKS"**.
4.  **Click on it.** You will see a live view of the robot running your commands step-by-step.

Tell me when you see it turn **Green**\! üü¢ (Or Red, and we will fix it).