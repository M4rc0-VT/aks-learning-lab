
### **Day 4: Helm Templating & Capacity Planning**

**Goal:** Refactor hardcoded YAML files into a reusable Helm Chart and debug resource constraints on a production-like node.

-----

### **1. The Helm Transformation** ‚õëÔ∏è

We moved from manual YAML files to a dynamic package structure.

**The Concept:**
Instead of maintaining `production.yaml` and `staging.yaml`, we create **One Template** and inject different **Values**.

**Key Commands:**

```powershell
# Create the chart skeleton
helm create my-nginx-app

# (We then deleted the default contents of 'templates/' and 'values.yaml' to start fresh)
```

**The Code (Templating):**
We injected a variable for the replica count.

  * **Source of Truth (`values.yaml`):**
    ```yaml
    replicaCount: 3
    ```
  * **The Blueprint (`templates/nginx-deployment.yaml`):**
    ```yaml
    spec:
      replicas: {{ .Values.replicaCount }}  # <--- The Mustache Syntax
    ```

**Deployment:**

```powershell
# Install the chart as a "Release"
helm install my-release ./my-nginx-app
```

-----

### **2. Troubleshooting: File Name vs. Resource Name** üïµÔ∏è‚Äç‚ôÇÔ∏è

You encountered a `NotFound` error when trying to restart the deployment.

**The Lesson:**
Kubernetes does not know your file names (`nginx-quickstart.yaml`). It only knows the **Resource Name** defined inside the `metadata:` block of the code.

**The Fix:**

```powershell
# 1. Find the REAL name
kubectl get deployments

# 2. Use that name in the command
kubectl rollout restart deployment/nginx-deployment
```

-----

### **3. Capacity Planning (The "Pending" Pods)** üìâ

When you asked for 3 replicas, one stuck in `Pending`.

**The Diagnosis:**

```powershell
kubectl describe pod <pod-name>
```

  * **Result:** `FailedScheduling ... Insufficient cpu`.
  * **The Math:** Your request (`250m` x 4 pods including surge = `1000m`) exceeded the free space on your single node, which shares CPU with system processes.

**The Fix (Vertical Scaling):**
We right-sized the application to fit the hardware by modifying the Helm template.

  * **Action:** Reduced `resources.requests.cpu` from `250m` to `100m`.
  * **Command:**
    ```powershell
    helm upgrade my-release ./my-nginx-app
    ```
  * **Result:** The scheduler successfully placed all pods on the node.

-----

### **4. Final Status**

  * **Cluster:** `lab-learning-aks`
  * **State:** Stopped (Billing Paused).
  * **Current Architecture:** 3 Nginx Pods managed by a custom Helm Chart, exposed via ClusterIP.

See you on the weekend for **Day 5: Infrastructure as Code (Terraform)**\! üèóÔ∏è