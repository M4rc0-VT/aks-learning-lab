Today is **Day 5**, and we are tackling the **Supply Chain**.
Right now, your Kubernetes cluster pulls images from **Docker Hub** (which is public).
For a real company, that is a security risk. You want a **Private Vault** for your code.

That vault is the **Azure Container Registry (ACR)**.

### **Step 1: Update the Infrastructure (Terraform)** üèóÔ∏è

We need to add the "Garage" (ACR) next to your "House" (AKS).

1.  Open your `C:\k8s-lab\terraform\main.tf` file.
2.  Add this new resource block at the bottom of the file.

<!-- end list -->

```hcl
# 5. The Container Registry (Private Vault)
resource "azurerm_container_registry" "acr" {
  name                = "acrlearninglab${random_string.suffix.result}" # Must be globally unique!
  resource_group_name = azurerm_resource_group.aks_rg.name
  location            = azurerm_resource_group.aks_rg.location
  sku                 = "Basic"           # Cheapest option for learning
  admin_enabled       = true              # Allows simple username/password login for now
}

# 6. Random String for Unique Names
# (Azure requires globally unique names for ACR, so we generate a random suffix)
resource "random_string" "suffix" {
  length  = 5
  special = false
  upper   = false
}
```

**Note:** I added a `random_string` resource because ACR names like "myregistry" are always taken by other people. This ensures yours is unique (e.g., `acrlearninglabx9z12`).

-----

### **Step 2: Apply the Changes** üöÄ

Let's build it.

1.  Open your terminal in `C:\k8s-lab\terraform`.
2.  Since we added a new provider (Random), we need to re-initialize:
    ```powershell
    terraform init
    ```
3.  Now apply the changes:
    ```powershell
    terraform apply
    ```
    *(Type `yes` when asked).*

**Wait for the green success message.**
Once done, copy the **name** of your new registry from the output (or check the Azure Portal). It will look like `acrlearninglabxxxxx`.

-----

### **Step 3: The Manual "Supply Chain"** üì¶

Now, let's manually do what the "Robot" will do next week: **Push an image.**

**1. Login to your new Registry**
(Replace `<your-acr-name>` with the actual name Terraform created)

```powershell
az acr login --name <your-acr-name> # az acr login --name acrlearninglab1oql4
```

*Result: "Login Succeeded"*

**2. Retag your Nginx Image**
We need to put a new "Address Label" on your image so Docker knows where to send it.

```powershell
# Pull the public one first (just to be sure)
docker pull nginx:latest

# Tag it for YOUR registry
docker tag nginx:latest <your-acr-name>.azurecr.io/my-nginx:v1
```

**3. Push it\!** üì§

```powershell
docker push <your-acr-name>.azurecr.io/my-nginx:v1
```

**Task:**
Run that push command. If you see progress bars uploading layers, **you have successfully built your own private software vault.**

------------------------

This is a classic "Docker is sleeping" error. üí§

The error `The system cannot find the file specified` for the pipe `dockerDesktopLinuxEngine` simply means **Docker Desktop is not running** on your laptop.

### **1. The Fix** üõ†Ô∏è

1.  Open your **Start Menu**, type "Docker Desktop", and launch it.
2.  Wait until the whale icon in your taskbar stops animating (it takes about minute).
3.  Run the command `docker ps` in your terminal.
      * If you see table headers (`CONTAINER ID...`), you are back in business.
      * **Then** run the `az acr login` command again.

-----

### **2. While Docker Starts: Answering Your Architecture Questions** üèóÔ∏è

You asked some excellent "Senior Architect" questions while waiting. Let's tackle them.

#### **Q1: What does SKU stand for?**

It stands for **Stock Keeping Unit**. In cloud terms, it basically means "The Product Tier" (e.g., Basic vs. Premium).

  * **Basic:** \~$0.16/day. (10GB storage included). No Firewall rules.
  * **Standard:** \~$0.66/day. (100GB storage). More speed.
  * **Premium:** \~$1.67/day. (500GB storage). Includes **Geo-Replication** and **Retention Policies**.

#### **Q2: Does ACR grow indefinitely? (The Cost Trap)**

**Yes.** Every time you push `v1`, then `v2`, then `v3`, the old layers stay there taking up space.

  * **The Hidden Cost:** Even if you delete the *tag* `v1`, the underlying data (manifests) often remains as "untagged" or "dangling" data, which you still pay for once you exceed 10GB.

#### **Q3: How do we clean it? (Garbage Collection)**

You asked for the "Good Practice" to automate this.

  * **Option A: The "Premium" Way (Easy)**
    If you pay for Premium, you can just set a policy, and Azure auto-deletes old images.
    *(But we are on Basic, so we can't use this)*.

  * **Option B: The "Terraform" Way (For Basic/Standard)**
    We can build a robot (an **ACR Task**) using Terraform that wakes up once a week and runs the `acr purge` command to delete old junk.

**Here is the code to add to your `main.tf` to solve this:**

```hcl
# 7. The "Janitor" Task (Garbage Collection)
resource "azurerm_container_registry_task" "cleaner" {
  name                  = "weekly-purge"
  container_registry_id = azurerm_container_registry.acr.id
  platform {
    os = "Linux"
  }

  # The Script: Delete tags older than 7 days and untagged manifests
  encoded_step {
    task_content = <<EOF
version: v1.1.0
steps:
  - cmd: acr purge --filter '.*:.*' --ago 7d --untagged
    disableWorkingDirectoryOverride: true
    timeout: 3600
EOF
  }

  # The Schedule: Run every Sunday at midnight
  timer_trigger {
    name     = "weekly"
    schedule = "0 0 * * 0"
    enabled  = true
  }
}
```

-----------------------------

### **How to Verify Your Work in the Portal** ‚òÅÔ∏è

1.  **Log in** to [portal.azure.com](https://www.google.com/search?q=https://portal.azure.com).
2.  In the top search bar, type **"Container registries"** and click the service icon (the blue box).
3.  You will see your registry named something like **`acrlearninglab1oql4`**. Click it.

**Once inside, check these two "Trophy" spots:**

  * üèÜ **The Image:**

      * Look at the left menu under **Services**.
      * Click **Repositories**.
      * You should see `my-nginx`. Click it, and you will see the `v1` tag you just pushed.

  * üßπ **The Janitor (If you ran `terraform apply`):**

      * Look at the left menu under **Services**.
      * Click **Tasks**.
      * You should see `weekly-purge` listed there.

-----

### **‚ö†Ô∏è Final Departure Checklist** ‚úàÔ∏è

Since you are heading to the airport/hotel and won't be using this lab on Monday:

1.  **The "FinOps" Move:**
    Run this command to delete everything so you pay **$0.00** while you travel.

    ```powershell
    terraform destroy
    ```

    *(Type `yes`. It takes \~5 mins. This cleans up the Cluster, the IP, and the Registry).*

2.  **The Code:**
    Your `main.tf` is safe on your hard drive. When you get to the hotel on Tuesday night, just run `terraform apply` and your entire datacenter will respawn in 8 minutes.

